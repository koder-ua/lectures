!SLIDE
## Архитектура (веб) сервисов с хранением данных в RAM

### Данилов Константин, Mirantis
### http://koder-ua.blogspot.com/
### https://github.com/koder-ua/

!SLIDE
## Mirantis
## hr@mirantis.com 
## Львов, Харьков 
## Python/C/C++/etc

![arch](../images/Mirantis-logo.png)  ![arch](../images/openstack-logo.jpg) 


!SLIDE
### Классическая архитуктура сервисов

    * Stateless сервервера
    * Многопоточный режим
    * Состояние в БД

![arch](../images/classic_arch.jpg) 

!SLIDE
### Отдельный поток

![arch](../images/classical_thread.jpg) 

!SLIDE
### Учет средств в сетевом маркетинге
### intvideo.tv

![tree](../images/tree.jpg)     


!SLIDE
### Городские легенды в IT
### The Free Lunch Is Over (c) Herb Sutter
    
    * Производительность процессоров заметно растет
    * Процессоры уже очень быстрые
    * Особенно если писать эффективный код

!SLIDE
### Бутылочное горлышко
    * Сеть
    * Диск
    * Синхронизация потоков
    * Дело не только в ожидании

!SLIDE
### Бутылочное горлышко
### MySQL (по версии VoltDB team):

    * > 20% Журнал отката/WAL
    * > 20% Блокировки
    * > 20% Управление буферами
    * > 20% Предвыборка данных
    * < 10% Полезная работа

!SLIDE
### Городские легенды в IT
### данных "over 9000" (c) FB, VK, etc.

    * "Холодные" и "Горячие" данные
    * OLTP vs OLAP
    * Количество новых "горячих" данных ограниченно
    * <10k новых горячих данных в день на человек

!SLIDE
### Современные компьютеры
    * EC2 - $2.8 за 244Gb ОЗУ/час (~2k$/month)
    * Горячие данные помещаются в ОЗУ


!SLIDE
### Как этим воспользоваться

    * Данные в памяти одного сервера
    * Параллельная пост- и предобработка
    * Вся логика в одном потоке
 
![arch](../images/ram_arch.jpg) 

!SLIDE
### Отказоустойчивость
    * Сбои - это снова исключения
    * Репликация
    * WAL + data dump

!SLIDE
### Линейная репликация
![arch](../images/line_replica.jpg) 

    * Сервера выстраиваются в "линию"
    * Все работают с "головой"
    * Новый сервер подключаентся к "хвосту"
    * Репликация с fork-копии

!SLIDE
### RAFT 
    * http://raftconsensus.github.io/
    * Выносится в отдельные процесс

!SLIDE
### Транзакции - fork
    * Втаскивание новой ноды и транзакции через fork
    * Особенности форка - замедление обоих процессов

!SLIDE
### Транзакционная память
    * Cпособ использовать дополнительные ядра
    * Транзакционная память + RAM ==
    * Транзакции + База

!SLIDE
### Масштабирование
    * Шардинг
    * Ручной
    * Тяжело
    * Не всегда эффективен

!SLIDE
### Примеры систем - LMAX
### ПО для биржи

    * Несколько потоков для сбора данных
    * Один поток для обработки транзакций в основной памяти
    * Несколько потоков для постобработки результатов
    * Disruptor - lock-free очередь с множеством писателей для обмена данными

!SLIDE
### Примеры систем
### Сетевой помошник

    * Надоедливые помощники на сайтайх
    * >10к пользователей
    * >1k помощников
    * 50к tps со старта

!SLIDE
### Производительность
    * VoltDB vs. MySQL, tpc-c - > ~100x
    * LMAX - >100k tps на одном ядре
    * Обычно ускорение ~100x



!SLIDE
### ВЫВОДЫ
    
    * + Скорость
    * + Простота и размер ядра системы
    * + Возможность переноса ядра на другой язык
    * - Сложное масштабирование
    * - Логика восстановления
    * - Состояние системы менее прозрачно

!SLIDE
### Спасибо

### Вопросы и помидоры







